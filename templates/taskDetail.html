{% extends "base.html" %}
{% load staticfiles %}
{% block content %}
    <div class="breadcrumbs">
        <div class="breadcrumbs-inner">
            <div class="row m-0">
                <div class="col-sm-4">
                    <div class="page-header float-left">
                        <div class="page-title">
                            <h1>Dashboard</h1>
                        </div>
                    </div>
                </div>
                <div class="col-sm-8">
                    <div class="page-header float-right">
                        <div class="page-title">
                            <ol class="breadcrumb text-right">
                                <li><a href="{% url 'index' %}">首页</a></li>
                                <li><a href="{% url 'showTask' %}">任务栏</a></li>
                                <li class="active">任务详情</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Content -->
    <div class="content">
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <strong class="card-title">执行任务</strong>
                        </div>
                        <div class="card-body">
                            <ul id="myTab" role="tablist">
                                {% for sequence in sequences %}
                                    {% if sequence.priority == 1 %}
                                        <li id="step1Li" class="active blue">
                                            <a href="#" role="tab" data-toggle="tab">
                                                1.{{ sequence.segment.name }}
                                            </a>
                                        </li>
                                    {% elif sequence.priority == 2 %}
                                        <li id="step2Li" class="gray">
                                            <img id="step2Img" src="{% static "images/blue_gray.png" %}"/>
                                            <a href="#" role="tab" data-toggle="tab">
                                                2.{{ sequence.segment.name }}
                                            </a>
                                        </li>
                                    {% else %}
                                        <li id="step{{ sequence.priority }}Li" class="gray">
                                            <img id="step{{ sequence.priority }}Img"
                                                 src="{% static "images/gray_gray.png" %}"/>
                                            <a href="#" role="tab" data-toggle="tab">
                                                {{ sequence.priority }}.{{ sequence.segment.name }}
                                            </a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                <li id="step{{ lastNum }}Li" class="gray">
                                    <img id="step{{ lastNum }}Img" src="{% static "images/gray_gray.png" %}"/>
                                    <a href="#" role="tab" data-toggle="tab">
                                        上线后验证
                                    </a>
                                </li>
                            </ul>
                            <div id="myTabContent" class="tab-content">
                                {% for sequence in sequences %}
                                    {% if sequence.priority == 1 %}
                                        {% if sequence.segment.isDeploy == 1 %}
                                            <div id="step1" class="tab-pane active">
                                                <h5 class="page-header"></h5>
                                                <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
                                                    <ul class="layui-tab-title">
                                                        <li class="layui-this">任务信息</li>
                                                        <li>任务执行</li>
                                                        <li>任务回滚</li>
                                                        <li>执行记录</li>
                                                    </ul>
                                                    <div class="layui-tab-content">
                                                        <div class="layui-tab-item layui-show">
                                                            <p>【标题】{{ task_obj.name }}</p>
                                                            <br>【执行顺序】
                                                            {% for project_plan in project_plans %}
                                                                <br>{{ project_plan.project.name }}：
                                                                {{ project_plan.lastPackageId }}
                                                            {% endfor %}
                                                        </div>
                                                        <div class="layui-tab-item">
                                                            <div class="site-demo-button"
                                                                 style="margin-top: 20px; margin-bottom: 0;">
                                                                <button class="layui-btn layui-btn-primary runTask"
                                                                        data-type="loading">立即执行
                                                                </button>
                                                                <button class="layui-btn layui-btn-primary continueTask fade"
                                                                        data-type="loading">继续发布
                                                                </button>
                                                                <h5 class="page-header"></h5>
                                                                <div class="layui-col-md12">
                                                                    <div class="layui-card">
                                                                        <div class="layui-card-header"><strong>控制台信息</strong></div>
                                                                        <div class="layui-card-body proBuildResult">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="layui-tab-item">
                                                            <div class="site-demo-button"
                                                                 style="margin-top: 20px; margin-bottom: 0;">
                                                                <button class="layui-btn layui-btn-primary rollback"
                                                                        data-type="loading">
                                                                    立即回滚
                                                                </button>
                                                                <h5 class="page-header"></h5>
                                                                <div class="layui-collapse RollBackResult"
                                                                     lay-accordion="">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="layui-tab-item">
                                                            <ul class="layui-timeline">
                                                                <button type="button"
                                                                        class="layui-btn layui-btn-primary"
                                                                        style="float: right"
                                                                        onclick="window.location.reload()">刷新
                                                                </button>
                                                                <h5 class="page-header"></h5>
                                                                {% for task in taskHistory %}
                                                                    <li class="layui-timeline-item">
                                                                        <i class="layui-icon layui-timeline-axis">&#xe63f;</i>
                                                                        <div class="layui-timeline-content layui-text">
                                                                            <h3 class="layui-timeline-title">{{ task.operateTime }}</h3>
                                                                            <p>{% if task.type == 1 %}
                                                                                操作：发布
                                                                            {% else %}
                                                                                操作：回滚
                                                                            {% endif %}
                                                                                <br>执行人：{{ task.operateUser.last_name }}{{ task.operateUser.first_name }}
                                                                                <br><a href="/console_opt/{{ task.suuid }}">查看控制台信息</a>
                                                                            </p>
                                                                        </div>
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="button" class="layui-btn layui-btn-primary"
                                                        style="float: right">
                                                    <a href="#step{{ sequence.next_segment }}"
                                                       onclick="eventFun.setStep({{ sequence.next_segment }})"
                                                       role="tab" data-toggle="tab">下一步</a></button>
                                            </div>
                                        {% else %}
                                            <div id="step1" class="tab-pane active">
                                                <h5 class="page-header"></h5>
                                                {% if sequence.implemented == 0 %}
                                                    <p id="p1" class="fade"></p>
                                                    <textarea class="form-control" name="desc" id="remark"
                                                              placeholder="请输入发布的一些备注（包括：需要执行的SQL、修改更新内容等等）"
                                                              rows="4" value=""></textarea>
                                                    <h5 class="page-header"></h5>
                                                    <button type="button" class="layui-btn layui-btn-primary segmentBtn"
                                                            id="{{ sequence.id }}">执行
                                                    </button>
                                                    <button type="button" id="nextBtn"
                                                            class="layui-btn layui-btn-primary fade"
                                                            style="float: right">
                                                        <a href="#step{{ sequence.next_segment }}"
                                                           onclick="eventFun.setStep({{ sequence.next_segment }})"
                                                           role="tab"
                                                           data-toggle="tab">下一步</a></button>
                                                {% else %}
                                                    <h5 class="page-header"></h5>
                                                    <p>
                                                        执行人：{{ sequence.executor.name }}</p>
                                                    <p>备注：{{ sequence.remarks }}</p>
                                                    <button type="button" class="layui-btn layui-btn-primary"
                                                            style="float: right">
                                                        <a href="#step{{ sequence.next_segment }}"
                                                           onclick="eventFun.setStep({{ sequence.next_segment }})"
                                                           role="tab"
                                                           data-toggle="tab">下一步</a></button>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        {% if sequence.segment.isDeploy == 1 %}
                                            <div id="step{{ sequence.priority }}" class="tab-pane fade">
                                                <h5 class="page-header"></h5>
                                                <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
                                                    <ul class="layui-tab-title">
                                                        <li class="layui-this">任务信息</li>
                                                        <li>任务执行</li>
                                                        <li>任务回滚</li>
                                                        <li>执行记录</li>
                                                    </ul>
                                                    <div class="layui-tab-content">
                                                        <div class="layui-tab-item layui-show">
                                                            <p>【标题】{{ task_obj.name }}</p>
                                                            <br>【执行顺序】
                                                            {% for project_plan in project_plans %}
                                                                <br>{{ project_plan.project.name }}：{{ project_plan.lastPackageId }}
                                                            {% endfor %}
                                                        </div>
                                                        <div class="layui-tab-item">
                                                            <div class="site-demo-button" style="margin-top: 20px; margin-bottom: 0;">
                                                                <button class="layui-btn layui-btn-primary runTask" data-type="loading">立即执行
                                                                </button>
                                                                <button class="layui-btn layui-btn-primary continueTask fade" data-type="loading">继续发布
                                                                </button>
                                                                <h5 class="page-header"></h5>
                                                                <div class="layui-col-md12">
                                                                    <div class="layui-card">
                                                                        <div class="layui-card-header"><strong>控制台信息</strong></div>
                                                                        <div class="layui-card-body proBuildResult">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="layui-tab-item">
                                                            <div class="site-demo-button"
                                                                 style="margin-top: 20px; margin-bottom: 0;">
                                                                <button class="layui-btn layui-btn-primary rollback" data-type="loading">
                                                                    立即回滚
                                                                </button>
                                                                <h5 class="page-header"></h5>
                                                                <div class="layui-collapse RollBackResult" lay-accordion=""></div>
                                                            </div>
                                                        </div>
                                                        <div class="layui-tab-item">
                                                            <ul class="layui-timeline">
                                                                <button type="button"
                                                                        class="layui-btn layui-btn-primary"
                                                                        style="float: right"
                                                                        onclick="window.location.reload()">刷新
                                                                </button>
                                                                <h5 class="page-header"></h5>
                                                                {% for task in taskHistory %}
                                                                    <li class="layui-timeline-item">
                                                                        <i class="layui-icon layui-timeline-axis">&#xe63f;</i>
                                                                        <div class="layui-timeline-content layui-text">
                                                                            <h3 class="layui-timeline-title">{{ task.operateTime }}</h3>
                                                                            <p>{% if task.type == 1 %}
                                                                                操作：发布
                                                                            {% else %}
                                                                                操作：回滚
                                                                            {% endif %}
                                                                                <br>执行人：{{ task.operateUser.last_name }}{{ task.operateUser.first_name }}
                                                                                <br><a href="/console_opt/{{ task.suuid }}">查看控制台信息</a>
                                                                            </p>
                                                                        </div>
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="button" class="layui-btn layui-btn-primary"
                                                        style="float: right">
                                                    <a href="#step{{ sequence.next_segment }}"
                                                       onclick="eventFun.setStep({{ sequence.next_segment }})"
                                                       role="tab" data-toggle="tab">下一步</a></button>
                                            </div>
                                        {% else %}
                                            <div id="step{{ sequence.priority }}" class="tab-pane fade">
                                                <h5 class="page-header"></h5>
                                                {% if sequence.implemented == 0 %}
                                                    <p id="p1" class="fade"></p>
                                                    <textarea class="form-control" name="desc" id="remark"
                                                              placeholder="请输入发布的一些备注（包括：需要执行的SQL、修改更新内容等等）"
                                                              rows="4"></textarea>
                                                    <h5 class="page-header"></h5>
                                                    <button type="button" class="layui-btn layui-btn-primary segmentBtn"
                                                            id="{{ sequence.id }}">执行
                                                    </button>
                                                    <button type="button" id="nextBtn"
                                                            class="layui-btn layui-btn-primary fade"
                                                            style="float: right">
                                                        <a href="#step{{ sequence.next_segment }}"
                                                           onclick="eventFun.setStep({{ sequence.next_segment }})"
                                                           role="tab" data-toggle="tab">下一步</a></button>
                                                {% else %}
                                                    <h5 class="page-header"></h5>
                                                    <p>
                                                        执行人：{{ sequence.executor.name }}</p>
                                                    <p>备注：{{ sequence.remarks }}</p>
                                                    <button type="button" class="layui-btn layui-btn-primary"
                                                            style="float: right">
                                                        <a href="#step{{ sequence.next_segment }}"
                                                           onclick="eventFun.setStep({{ sequence.next_segment }})"
                                                           role="tab" data-toggle="tab">下一步</a></button>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <div id="step{{ lastNum }}" class="tab-pane fade">
                                    <h5 class="page-header"></h5>
                                    {% if task.checked == 0 %}
                                        <p id="p1" class="fade"></p>
                                        <textarea class="form-control" name="remark" id="remark"
                                                  placeholder="请输入发布的一些备注（包括：需要执行的SQL、修改更新内容等等）" rows="4"></textarea>
                                        <h5 class="page-header"></h5>
                                        <button type="button" class="layui-btn layui-btn-primary autoCodeMerge">验证通过
                                        </button>
                                    {% else %}
                                        <p id="p1">
                                            <br>执行人：{{ task.checkUser.last_name }}{{ task.checkUser.first_name }}
                                            <br>执行日期：{{ task.checkDate }}
                                            <br>备注：{{ task.remark }}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- .animated -->
        </div><!-- .content -->
    </div>
{% endblock %}